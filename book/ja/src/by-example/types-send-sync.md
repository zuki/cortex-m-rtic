# 型、SendとSync

`APP`擬似モジュール内のすべての関数は、その最初のパラメータとして`Context`構造体を持ちます。これらの構造体のすべてのフィールドは予測可能で非匿名な型を持っていますので、それらを引数とするプレーンな関数を書くことができます。

APIリファレンスはこれらの型が入力からどのように生成されるかを明記しています。バイナリクレートのドキュメントを生成することもできます (`cargo doc --bin <name>`)。ドキュメントの中で`Context`構造体（`init::Context`や`idle::Context`など）を見つけることができるでしょう。

以下の例は、`app`属性によって生成される様々なタイプを示しています。

``` **rust**
{{#include ../../../../examples/types.rs}}
```

### `Context`構造体のフィールドの型の例

```rust
{{#rustdoc_include ../../../../memos/memo_1_5.rs:1:10}}
```

## `Send`

[`Send`]は、`core`における定義によると「スレッド境界を越えて転送できる型」のためのマーカートレイトです。RTICのコンテキストでは、*異なる*優先度で実行するタスク間で値を転送することが可能な場合にのみ`Send`トレイトが必要となります。これはメッセージパッシング、共有リソース、遅延リソースの初期化など、いくつかの場所で発生します。

[`Send`]: https://doc.rust-lang.org/core/marker/trait.Send.html

`app`属性は必要な場所に`Send`が実装されていることを強制しますので、あまり気にする必要はありません。`Send`トレイトを必要と*しない*場所を知っておくことの方が重要です。すなわち、*同じ*優先度で実行するタスク間で転送される型です。これはメッセージの受け渡しと共有リソースの２箇所で発生します。

以下の例では、`Send`を実装していない型を使用できる場所を示しています。

``` rust
{{#include ../../../../examples/not-send.rs}}
```

ここで、リソースの遅延初期化は、最も低い優先度`0`のバックグラウンドコンテキストから`1`以上の優先度で実行するタスクに初期値を送信する操作であることに注意することが重要です。したがって、すべての遅延リソースは、優先度`0`で実行する`idle`により排他的にアクセスされるものを除いて、`Send`トレイトを実装する必要があります。

次の例でからわかるように、`init`とのリソースの共有を遅延初期化の実装に使用することができます。そのため、`init`と共有するリソースも`Send`トレイトを実装しなければなりません。

``` rust
{{#include ../../../../examples/shared-with-init.rs}}
```

## `Sync`

同様に、[`Sync`]はコアの定義によると「スレッド間で参照を共有しても安全な型」のためのマーカートレイトです。RTIC のコンテキストでは、異なる優先度で実行する2つ以上のタスクが、あるリソースへの共有参照 (`&-`) を取得できる場合のみ`Sync`トレイトが必要となります。これは共有アクセス(`&-`)リソースでのみ発生します。

[`Sync`]: https://doc.rust-lang.org/core/marker/trait.Sync.html

`app`属性は属性は必要な場所に`Sync`が実装されていることを強制しますが、`Sync`が必要とされない場所、すなわち、*同じ*優先度で実行するタスクが競合する共有アクセス(`&-`)リソースを知っておくことが重要です。

以下の例では、`Sync`を実装していない型を使用できる場所を示しています。

``` rust
{{#include ../../../../examples/not-sync.rs}}
```
